# 微信登录和支付配置指南

## 📋 概述

本系统已集成微信登录和微信支付功能。由于微信登录和支付需要服务器端支持，本文档说明如何配置和使用这些功能。

## 🔐 微信登录配置

### 1. 申请微信开放平台账号

1. 访问 [微信开放平台](https://open.weixin.qq.com/)
2. 注册并认证开发者账号
3. 创建网站应用，获取 `AppID` 和 `AppSecret`

### 2. 配置授权回调域名

在微信开放平台设置授权回调域名为：`yourdomain.com`

### 3. 修改配置

编辑 `auth.js` 文件，找到以下代码：

```javascript
const WECHAT_APP_ID = 'YOUR_WECHAT_APP_ID'; // 替换为您的AppID
```

### 4. 服务器端实现

需要创建以下服务器端API：

- `POST /api/wechat/login` - 处理微信OAuth回调，通过code获取用户信息
- 返回格式：`{ openId, nickname, avatar, ... }`

## 💰 微信支付配置

### 1. 申请微信支付商户号

1. 访问 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 注册并认证商户账号
3. 获取商户号（mch_id）和API密钥

### 2. 配置支付参数

编辑 `payment.js` 文件，配置支付相关参数。

### 3. 服务器端实现

需要创建以下服务器端API：

- `POST /api/wechat/pay` - 生成支付参数（移动端JSAPI）
  - 请求：`{ orderId, amount }`
  - 返回：`{ appId, timeStamp, nonceStr, package, signType, paySign }`

- `POST /api/wechat/qrcode` - 生成支付二维码（PC端）
  - 请求：`{ orderId, amount }`
  - 返回：`{ qrCodeUrl }`

- `GET /api/wechat/payment-status` - 查询支付状态
  - 请求：`?orderId=xxx`
  - 返回：`{ status: 'success' | 'pending' | 'failed', orderId }`

- `POST /api/wechat/payment-callback` - 支付回调接口（微信服务器调用）
  - 处理支付成功通知，更新订单状态

## 🚀 使用流程

### 微信登录流程

1. 用户点击"微信登录"按钮
2. 跳转到微信授权页面
3. 用户授权后，微信回调到 `wechat-callback.html`
4. 页面通过code调用服务器API获取用户信息
5. 自动登录或注册用户

### 微信支付流程

#### 移动端（JSAPI）

1. 用户点击"购买"按钮
2. 跳转到支付页面
3. 调用服务器API生成支付参数
4. 调用微信JS-SDK发起支付
5. 支付成功后，服务器回调更新订单状态
6. 前端更新用户AI查询次数

#### PC端（二维码）

1. 用户点击"购买"按钮
2. 跳转到支付页面
3. 调用服务器API生成支付二维码
4. 用户使用微信扫码支付
5. 前端轮询支付状态
6. 支付成功后更新用户AI查询次数

## 📝 注意事项

1. **安全性**：所有涉及支付的操作必须在服务器端完成，前端只负责展示和调用
2. **回调验证**：支付回调必须验证签名，确保安全性
3. **订单管理**：建议在服务器端维护订单状态，避免重复支付
4. **测试环境**：可以使用微信支付沙箱环境进行测试

## 🔧 当前实现状态

当前实现为**前端框架**，包含：
- ✅ 微信登录UI和流程框架
- ✅ 微信支付UI和流程框架
- ✅ 用户数据管理（支持微信登录用户）
- ✅ 购买记录管理
- ✅ AI查询次数管理

**需要补充**：
- ⚠️ 服务器端OAuth处理
- ⚠️ 服务器端支付参数生成
- ⚠️ 服务器端支付回调处理
- ⚠️ 真实的微信JS-SDK集成

## 🧪 测试模式

在开发环境中，可以使用模拟模式测试功能：

1. 微信登录：点击后会模拟登录流程（创建测试用户）
2. 微信支付：点击后会模拟支付成功（自动增加AI次数）

生产环境需要替换为真实的API调用。

